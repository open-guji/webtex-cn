<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebTeX-CN 示例</title>
<link rel="stylesheet" href="../src/templates/base.css">
<link id="template-css" rel="stylesheet" href="../src/templates/siku-quanshu.css">
<style>
  /* Override base.css body for demo app layout */
  body {
    background: #f0f0f0;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    padding: 0;
    margin: 0;
    height: 100vh;
    overflow: hidden;
    font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
  }

  .controls {
    padding: 10px 20px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .controls h1 {
    font-size: 15px;
    color: #333;
    margin: 0;
    white-space: nowrap;
  }

  .controls select {
    font-size: 13px;
    padding: 4px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
  }

  .controls label {
    font-size: 13px;
    color: #555;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .workspace {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .editor-panel {
    width: 38%;
    min-width: 280px;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ccc;
    background: #1e1e1e;
  }

  .editor-panel textarea {
    flex: 1;
    resize: none;
    border: none;
    outline: none;
    padding: 16px;
    font-family: "Fira Code", "Consolas", "Monaco", monospace;
    font-size: 13px;
    line-height: 1.6;
    tab-size: 2;
    background: #1e1e1e;
    color: #d4d4d4;
    white-space: pre-wrap;
    word-break: break-all;
    overflow: auto;
  }

  .preview-panel {
    flex: 1;
    overflow: auto;
    padding: 20px;
    background: #e8e8e8;
  }

  #webtex-container {
    display: inline-block;
    transform-origin: top left;
  }

  .status-bar {
    padding: 4px 12px;
    background: #f5f5f5;
    border-top: 1px solid #ddd;
    font-size: 11px;
    color: #888;
    flex-shrink: 0;
  }
</style>
</head>
<body>
<div class="controls">
  <h1>WebTeX-CN</h1>
  <label>文件:
    <select id="tex-select">
      <option value="minimal.tex">最小示例</option>
      <option value="shiji.tex" selected>史记五帝本纪</option>
      <option value="honglou.tex">红楼梦甲戌本</option>
      <option value="showcase.tex">全功能展示</option>
    </select>
  </label>
  <label>模板:
    <select id="template-select">
      <option value="siku-quanshu" selected>四库全书 (黑白)</option>
      <option value="siku-quanshu-colored">四库全书 (彩色)</option>
      <option value="honglou">红楼梦甲戌本</option>
      <option value="minimal">极简</option>
    </select>
  </label>
</div>

<div class="workspace">
  <div class="editor-panel">
    <textarea id="tex-source" spellcheck="false" placeholder="在此输入 TeX 源文件..."></textarea>
  </div>
  <div class="preview-panel" id="preview-panel">
    <div id="webtex-container"></div>
  </div>
</div>

<div class="status-bar" id="status">就绪</div>

<script type="module">
import { renderToDOM } from '../src/index.js';

const texSource = document.getElementById('tex-source');
const container = document.getElementById('webtex-container');
const previewPanel = document.getElementById('preview-panel');
const status = document.getElementById('status');
const texSelect = document.getElementById('tex-select');
const templateSelect = document.getElementById('template-select');

let renderTimer = null;

function renderPreview() {
  const source = texSource.value;
  if (!source.trim()) {
    container.innerHTML = '';
    return;
  }
  try {
    renderToDOM(source, container);
    paginate();
    updateScale();
    status.textContent = '渲染完成';
  } catch (err) {
    status.textContent = '渲染错误: ' + err.message;
    console.error(err);
  }
}

function debouncedRender() {
  clearTimeout(renderTimer);
  renderTimer = setTimeout(renderPreview, 300);
}

function paginate() {
  var page = container.querySelector('.wtc-page');
  if (!page) return;

  // Remove previously created extra pages
  container.querySelectorAll('.wtc-page-extra').forEach(function (el) { el.remove(); });

  var rightContent = page.querySelector('.wtc-half-right .wtc-content');
  var leftContent = page.querySelector('.wtc-half-left .wtc-content');
  if (!rightContent || !leftContent) return;

  // Measure overflow (overflow:hidden still reports full scrollWidth)
  var totalWidth = rightContent.scrollWidth;
  var visibleWidth = rightContent.clientWidth;

  if (totalWidth <= visibleWidth + 2) {
    leftContent.innerHTML = '';
    return;
  }

  // Column metrics
  var cs = getComputedStyle(page);
  var nCols = parseInt(cs.getPropertyValue('--wtc-n-cols')) || 8;
  var colWidth = visibleWidth / nCols;
  var totalCols = Math.ceil(totalWidth / colWidth);
  var contentHTML = rightContent.innerHTML;

  // Fill left half of first page (columns nCols+1 to 2*nCols)
  var offset1 = nCols * colWidth;
  leftContent.innerHTML = '<div style="position:relative;left:' + offset1 + 'px">' + contentHTML + '</div>';

  // Create additional pages for remaining columns
  var colsShown = nCols * 2;
  var remaining = totalCols - colsShown;
  var pageNum = 1;
  var prevEl = page;
  var tmpl = page.getAttribute('data-template') || '';
  var spreadSetup = page.querySelector('.wtc-spread');
  var setupStyle = spreadSetup ? spreadSetup.getAttribute('style') || '' : '';

  while (remaining > 0) {
    var newPage = document.createElement('div');
    newPage.className = 'wtc-page wtc-page-extra';
    if (tmpl) newPage.setAttribute('data-template', tmpl);

    var offR = pageNum * 2 * nCols * colWidth;
    var offL = (pageNum * 2 + 1) * nCols * colWidth;
    var leftHTML = remaining > nCols
      ? '<div style="position:relative;left:' + offL + 'px">' + contentHTML + '</div>'
      : '';

    newPage.innerHTML = '<div class="wtc-spread"' + (setupStyle ? ' style="' + setupStyle + '"' : '') + '>' +
      '<div class="wtc-half-page wtc-half-right"><div class="wtc-content-border"><div class="wtc-content">' +
      '<div style="position:relative;left:' + offR + 'px">' + contentHTML + '</div>' +
      '</div></div></div>' +
      '<div class="wtc-half-page wtc-half-left"><div class="wtc-content-border"><div class="wtc-content">' +
      leftHTML +
      '</div></div></div>' +
      '</div>';

    prevEl.after(newPage);
    prevEl = newPage;
    remaining -= nCols * 2;
    pageNum++;
  }
}

function updateScale() {
  var pages = container.querySelectorAll('.wtc-page');
  if (!pages.length) return;
  pages.forEach(function (p) { p.style.zoom = ''; });
  requestAnimationFrame(function () {
    var panelWidth = previewPanel.clientWidth - 40;
    var pageWidth = pages[0].offsetWidth;
    if (pageWidth > panelWidth && pageWidth > 0) {
      var scale = panelWidth / pageWidth;
      pages.forEach(function (p) { p.style.zoom = scale; });
    }
  });
}

async function loadTeX(filename) {
  status.textContent = '加载 ' + filename + '...';
  try {
    const response = await fetch(filename);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    texSource.value = await response.text();
    renderPreview();
  } catch (err) {
    status.textContent = '错误: ' + err.message;
    console.error(err);
  }
}

function switchTemplate(name) {
  const link = document.getElementById('template-css');
  link.href = '../src/templates/' + name + '.css';
  link.onload = function () {
    renderPreview();
  };
}

// Event listeners
texSource.addEventListener('input', debouncedRender);
texSelect.addEventListener('change', function () { loadTeX(texSelect.value); });
templateSelect.addEventListener('change', function () { switchTemplate(templateSelect.value); });

// Re-scale on resize
new ResizeObserver(function () { updateScale(); }).observe(previewPanel);

// Auto-load default file
loadTeX('shiji.tex');
</script>
</body>
</html>
